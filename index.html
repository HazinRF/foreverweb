<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—à–∞ —Å–≤—è–∑—å üíôüíó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f0f0f;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: none;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        #connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
        }
        .connection-dot.connected {
            background: #2ed573;
            animation: pulse 2s infinite;
        }
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .fingerprint-symbol {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -50%);
            opacity: 0;
            animation: fingerprintAppear 0.5s ease-out forwards,
                       fingerprintFade 5s ease-in 0.5s forwards;
        }
        @keyframes fingerprintAppear {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
        }
        @keyframes fingerprintFade {
            0% { opacity: 0.9; }
            100% { opacity: 0; }
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        #instructions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            font-size: 16px;
            backdrop-filter: blur(5px);
            animation: pulse 2s infinite;
        }
        .hidden {
            display: none !important;
        }
        #user-count {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <div id="status">üíô –û–Ω (Android)</div>
    <div id="connection-status">
        <span class="connection-dot"></span>
        <span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</span>
    </div>
    <div id="user-count" class="hidden"></div>
    <canvas id="canvas"></canvas>
    <div id="instructions">–ö–æ—Å–Ω–∏—Å—å —ç–∫—Ä–∞–Ω–∞ –∏–ª–∏ —Ä–∏—Å—É–π –ø–∞–ª—å—Ü–µ–º üí´</div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        const WS_SERVER_URL = 'wss://our-drawing-site.onrender.com';
        
        // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–õ–ê–¢–§–û–†–ú–´ ===
        const userAgent = navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(userAgent);
        const isAndroid = /android/.test(userAgent);
        
        let userColor, userName, userId;
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        if (isAndroid) {
            userColor = '#3498db';
            userName = '–û–Ω (Android)';
        } else if (isIOS) {
            userColor = '#e84393';
            userName = '–û–Ω–∞ (iPhone)';
        } else {
            userColor = '#9b59b6';
            userName = '–ì–æ—Å—Ç—å';
        }

        // === –≠–õ–ï–ú–ï–ù–¢–´ ===
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const connectionEl = document.getElementById('connection-status');
        const connectionDot = connectionEl.querySelector('.connection-dot');
        const instructionsEl = document.getElementById('instructions');
        const userCountEl = document.getElementById('user-count');

        // === –°–û–°–¢–û–Ø–ù–ò–ï ===
        let activeLines = new Map();
        let taps = new Map();
        let currentLineId = null;
        let ws = null;
        let isConnected = false;
        let onlineUsers = 0;

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø CANVAS ===
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawAllLines();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        statusEl.textContent = userName;
        statusEl.style.color = userColor;

        // === WEB SOCKET ===
        function connectWebSocket() {
            ws = new WebSocket(WS_SERVER_URL);
            
            ws.onopen = () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                isConnected = true;
                connectionDot.classList.add('connected');
                connectionEl.innerHTML = '<span class="connection-dot connected"></span><span>–°–æ–µ–¥–∏–Ω–µ–Ω–æ</span>';
                
                ws.send(JSON.stringify({
                    type: 'user_join',
                    userId,
                    userColor,
                    userName,
                    platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop'
                }));
            };
            
            ws.onclose = () => {
                console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                isConnected = false;
                connectionDot.classList.remove('connected');
                connectionEl.innerHTML = '<span class="connection-dot"></span><span>–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
                setTimeout(connectWebSocket, 2000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                }
            };
        }

        // === –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –° –°–ï–†–í–ï–†–ê ===
        function handleServerMessage(data) {
            switch (data.type) {
                case 'line_start':
                    if (!activeLines.has(data.lineId)) {
                        activeLines.set(data.lineId, {
                            id: data.lineId,
                            points: [data.point],
                            color: data.userColor,
                            width: isIOS ? 12 : 10,
                            userId: data.userId,
                            fading: false,
                            endTime: null,
                            alpha: 1
                        });
                        drawAllLines();
                    }
                    break;
                    
                case 'line_update':
                    const line = activeLines.get(data.lineId);
                    if (line) {
                        line.points.push(data.point);
                        drawAllLines();
                    }
                    break;
                    
                case 'line_end':
                    const endLine = activeLines.get(data.lineId);
                    if (endLine) {
                        // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –í–°–ï–•
                        endLine.fading = true;
                        endLine.endTime = data.endTime || Date.now();
                        endLine.fadeStartTime = Date.now();
                        drawAllLines();
                        
                        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                        setTimeout(() => {
                            activeLines.delete(data.lineId);
                            drawAllLines();
                        }, 5000);
                    }
                    break;
                    
                case 'tap':
                    createFingerprintSymbol(data.point.x, data.point.y, data.userColor);
                    break;
                    
                case 'user_count':
                    onlineUsers = data.count;
                    userCountEl.textContent = `–û–Ω–ª–∞–π–Ω: ${onlineUsers}`;
                    userCountEl.classList.remove('hidden');
                    break;
            }
        }

        // === –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –û–¢–ü–ï–ß–ê–¢–ö–ê (SVG —Å–∏–º–≤–æ–ª) ===
        function createFingerprintSymbol(x, y, color) {
            const svgNS = "http://www.w3.org/2000/svg";
            const fingerprint = document.createElementNS(svgNS, "svg");
            fingerprint.setAttribute("class", "fingerprint-symbol");
            fingerprint.setAttribute("width", "80");
            fingerprint.setAttribute("height", "80");
            fingerprint.setAttribute("viewBox", "0 0 80 80");
            fingerprint.style.left = x + 'px';
            fingerprint.style.top = y + 'px';
            fingerprint.style.color = color;
            
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –ø–∞–ª—å—Ü–∞
            const paths = [
                "M40,20 C30,20 20,30 20,40 C20,50 30,60 40,60 C50,60 60,50 60,40 C60,30 50,20 40,20 Z",
                "M40,25 C32,25 25,32 25,40 C25,48 32,55 40,55 C48,55 55,48 55,40 C55,32 48,25 40,25 Z",
                "M40,30 C34,30 30,34 30,40 C30,46 34,50 40,50 C46,50 50,46 50,40 C50,34 46,30 40,30 Z",
                "M35,35 L35,45",
                "M45,35 L45,45",
                "M30,38 L30,42",
                "M50,38 L50,42"
            ];
            
            paths.forEach((d, i) => {
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", d);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", "currentColor");
                path.setAttribute("stroke-width", i < 3 ? "3" : "2");
                path.setAttribute("stroke-linecap", "round");
                fingerprint.appendChild(path);
            });
            
            document.body.appendChild(fingerprint);
            
            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (fingerprint.parentNode) {
                    fingerprint.parentNode.removeChild(fingerprint);
                }
            }, 5500);
        }

        // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–ê–°–ê–ù–ò–ô ===
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd);
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (!isConnected) return;
            
            const touch = e.changedTouches[0];
            const point = { x: touch.clientX, y: touch.clientY };
            
            // –í–∏–±—Ä–∞—Ü–∏—è
            if (navigator.vibrate) navigator.vibrate(15);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º TAP (–∫–æ—Ä–æ—Ç–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è)
            ws.send(JSON.stringify({
                type: 'tap',
                point: point,
                userColor: userColor,
                userId: userId
            }));
            
            // –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª –æ—Ç–ø–µ—á–∞—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ
            createFingerprintSymbol(point.x, point.y, userColor);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ª–∏–Ω–∏—é –¥–ª—è —Å–≤–∞–π–ø–∞
            currentLineId = 'line_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            activeLines.set(currentLineId, {
                id: currentLineId,
                points: [point],
                color: userColor,
                width: isIOS ? 12 : 10,
                userId: userId,
                fading: false,
                endTime: null,
                alpha: 1
            });
            
            ws.send(JSON.stringify({
                type: 'line_start',
                lineId: currentLineId,
                point: point,
                userColor: userColor,
                userId: userId
            }));
            
            drawAllLines();
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isConnected || !currentLineId) return;
            
            const touch = e.changedTouches[0];
            const point = { x: touch.clientX, y: touch.clientY };
            
            const line = activeLines.get(currentLineId);
            if (line) {
                line.points.push(point);
                
                ws.send(JSON.stringify({
                    type: 'line_update',
                    lineId: currentLineId,
                    point: point
                }));
                
                drawAllLines();
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!isConnected || !currentLineId) return;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ª–∏–Ω–∏–∏
            ws.send(JSON.stringify({
                type: 'line_end',
                lineId: currentLineId
            }));
            
            // –õ–æ–∫–∞–ª—å–Ω–æ –ø–æ–º–µ—á–∞–µ–º –ª–∏–Ω–∏—é –∫–∞–∫ –∏—Å—á–µ–∑–∞—é—â—É—é
            const line = activeLines.get(currentLineId);
            if (line) {
                line.fading = true;
                line.endTime = Date.now();
                line.fadeStartTime = Date.now();
                
                // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                setTimeout(() => {
                    activeLines.delete(currentLineId);
                    drawAllLines();
                }, 5000);
            }
            
            currentLineId = null;
            drawAllLines();
        }

        // === –ü–õ–ê–í–ù–û–ï –ò–°–ß–ï–ó–ù–û–í–ï–ù–ò–ï –õ–ò–ù–ò–ô ===
        function drawAllLines() {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.fillStyle = '#0f0f0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const now = Date.now();
            
            // –†–∏—Å—É–µ–º –≤—Å–µ –ª–∏–Ω–∏–∏
            for (const [lineId, line] of activeLines) {
                if (line.points.length < 2) continue;
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –∏—Å—á–µ–∑–∞—é—â–∏—Ö –ª–∏–Ω–∏–π
                let alpha = 1;
                if (line.fading && line.endTime) {
                    const timeSinceEnd = now - line.endTime;
                    const fadeProgress = Math.min(timeSinceEnd / 5000, 1); // 5 —Å–µ–∫—É–Ω–¥
                    
                    // –ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                    alpha = 1 - fadeProgress;
                    alpha = Math.pow(alpha, 2); // –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ –ø—Ä–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–∏
                    ctx.filter = `blur(${fadeProgress * 8}px)`;
                } else {
                    ctx.filter = 'none';
                }
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                ctx.beginPath();
                ctx.moveTo(line.points[0].x, line.points[0].y);
                
                for (let i = 1; i < line.points.length; i++) {
                    ctx.lineTo(line.points[i].x, line.points[i].y);
                }
                
                // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—É—é –ª–∏–Ω–∏—é
                if (line.points.length > 1) {
                    const gradient = ctx.createLinearGradient(
                        line.points[0].x, line.points[0].y,
                        line.points[line.points.length-1].x, line.points[line.points.length-1].y
                    );
                    gradient.addColorStop(0, line.color.replace(')', `, ${alpha * 0.8})`).replace('rgb', 'rgba'));
                    gradient.addColorStop(1, line.color.replace(')', `, ${alpha * 0.3})`).replace('rgb', 'rgba'));
                    
                    ctx.strokeStyle = gradient;
                } else {
                    ctx.strokeStyle = line.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                }
                
                ctx.lineWidth = line.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                ctx.filter = 'none';
            }
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—á–µ–∑–∞—é—â–∏–µ –ª–∏–Ω–∏–∏
            const hasFadingLines = Array.from(activeLines.values()).some(line => line.fading);
            if (hasFadingLines) {
                requestAnimationFrame(drawAllLines);
            }
        }

        // === –ü–û–î–î–ï–†–ñ–ö–ê –ú–´–®–ò ===
        let isMouseDown = false;
        let mouseLineId = null;
        
        canvas.addEventListener('mousedown', (e) => {
            if (!isConnected) return;
            
            isMouseDown = true;
            const point = { x: e.clientX, y: e.clientY };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º tap
            ws.send(JSON.stringify({
                type: 'tap',
                point: point,
                userColor: userColor,
                userId: userId
            }));
            
            createFingerprintSymbol(point.x, point.y, userColor);
            
            mouseLineId = 'mouse_' + Date.now();
            activeLines.set(mouseLineId, {
                id: mouseLineId,
                points: [point],
                color: userColor,
                width: 8,
                userId: userId,
                fading: false,
                endTime: null,
                alpha: 1
            });
            
            ws.send(JSON.stringify({
                type: 'line_start',
                lineId: mouseLineId,
                point: point,
                userColor: userColor,
                userId: userId
            }));
            
            drawAllLines();
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isConnected || !isMouseDown || !mouseLineId) return;
            
            const point = { x: e.clientX, y: e.clientY };
            const line = activeLines.get(mouseLineId);
            
            if (line) {
                line.points.push(point);
                
                ws.send(JSON.stringify({
                    type: 'line_update',
                    lineId: mouseLineId,
                    point: point
                }));
                
                drawAllLines();
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            if (!isConnected || !mouseLineId) return;
            
            ws.send(JSON.stringify({
                type: 'line_end',
                lineId: mouseLineId
            }));
            
            const line = activeLines.get(mouseLineId);
            if (line) {
                line.fading = true;
                line.endTime = Date.now();
                line.fadeStartTime = Date.now();
                
                setTimeout(() => {
                    activeLines.delete(mouseLineId);
                    drawAllLines();
                }, 5000);
            }
            
            mouseLineId = null;
            isMouseDown = false;
            drawAllLines();
        });

        // === –ó–ê–ì–†–£–ó–ö–ê ===
        window.addEventListener('load', () => {
            setTimeout(() => {
                instructionsEl.classList.add('hidden');
            }, 5000);
            
            connectWebSocket();
        });
    </script>
</body>
</html>