<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—à–∞ —Å–≤—è–∑—å üíôüíó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f0f0f;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            max-width: 80%;
        }
        #connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
        }
        .connection-dot.connected {
            background: #2ed573;
            animation: pulse 2s infinite;
        }
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .vibration-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -50%);
            animation: pulse 0.4s ease-out;
        }
        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0px currentColor; 
                opacity: 1;
            }
            100% { 
                box-shadow: 0 0 0 40px transparent; 
                opacity: 0;
            }
        }
        .line-fade-out {
            animation: fadeOutLine 5s linear forwards;
        }
        @keyframes fadeOutLine {
            0% { 
                opacity: 1;
                filter: blur(0px);
            }
            70% { 
                opacity: 0.7;
                filter: blur(0px);
            }
            100% { 
                opacity: 0;
                filter: blur(10px);
            }
        }
        #instructions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            font-size: 16px;
            max-width: 90%;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .hidden {
            display: none !important;
        }
        #user-count {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <div id="status">üíô –û–Ω (Android)</div>
    <div id="connection-status">
        <span class="connection-dot"></span>
        <span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</span>
    </div>
    <div id="user-count" class="hidden"></div>
    <canvas id="canvas"></canvas>
    <div id="instructions">–ö–æ—Å–Ω–∏—Å—å —ç–∫—Ä–∞–Ω–∞ –∏–ª–∏ —Ä–∏—Å—É–π –ø–∞–ª—å—Ü–µ–º üí´</div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –ê–î–†–ï–° –°–ï–†–í–ï–†–ê
        const WS_SERVER_URL = 'wss://our-drawing-site.onrender.com';
        // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞ –±—É–¥–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
        // const WS_SERVER_URL = 'wss://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.onrender.com';

        // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–õ–ê–¢–§–û–†–ú–´ ===
        const userAgent = navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(userAgent);
        const isAndroid = /android/.test(userAgent);
        
        let userColor, userName, userId;
        
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        if (isAndroid) {
            userColor = '#3498db'; // –°–∏–Ω–∏–π
            userName = '–û–Ω (Android)';
        } else if (isIOS) {
            userColor = '#e84393'; // –†–æ–∑–æ–≤—ã–π
            userName = '–û–Ω–∞ (iPhone)';
        } else {
            userColor = '#9b59b6'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
            userName = '–ì–æ—Å—Ç—å';
        }

        // === –≠–õ–ï–ú–ï–ù–¢–´ –î–û–ú ===
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const connectionEl = document.getElementById('connection-status');
        const connectionDot = connectionEl.querySelector('.connection-dot');
        const instructionsEl = document.getElementById('instructions');
        const userCountEl = document.getElementById('user-count');

        // === –°–û–°–¢–û–Ø–ù–ò–ï ===
        let activeLines = new Map(); // Map: lineId -> lineData
        let currentLineId = null;
        let ws = null;
        let isConnected = false;
        let onlineUsers = 0;

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø CANVAS ===
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawAllLines();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        statusEl.textContent = `${userName}`;
        statusEl.style.color = userColor;

        // === WEB SOCKET –°–û–ï–î–ò–ù–ï–ù–ò–ï ===
        function connectWebSocket() {
            ws = new WebSocket(WS_SERVER_URL);
            
            ws.onopen = () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                isConnected = true;
                connectionDot.classList.add('connected');
                connectionEl.innerHTML = '<span class="connection-dot connected"></span><span>–°–æ–µ–¥–∏–Ω–µ–Ω–æ</span>';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                ws.send(JSON.stringify({
                    type: 'user_join',
                    userId,
                    userColor,
                    userName,
                    platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop'
                }));
            };
            
            ws.onclose = () => {
                console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                isConnected = false;
                connectionDot.classList.remove('connected');
                connectionEl.innerHTML = '<span class="connection-dot"></span><span>–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
                setTimeout(connectWebSocket, 2000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                }
            };
        }

        // === –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –° –°–ï–†–í–ï–†–ê ===
        function handleServerMessage(data) {
            switch (data.type) {
                case 'line_start':
                    createLineFromServer(data);
                    break;
                    
                case 'line_update':
                    updateLineFromServer(data);
                    break;
                    
                case 'line_end':
                    endLineFromServer(data);
                    break;
                    
                case 'user_count':
                    onlineUsers = data.count;
                    userCountEl.textContent = `–û–Ω–ª–∞–π–Ω: ${onlineUsers}`;
                    userCountEl.classList.remove('hidden');
                    break;
                    
                case 'clear_lines':
                    activeLines.clear();
                    drawAllLines();
                    break;
            }
        }

        // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –õ–ò–ù–ò–Ø–ú–ò ===
        function createLineFromServer(data) {
            const line = {
                id: data.lineId,
                points: [data.point],
                color: data.userColor,
                width: data.platform === 'ios' ? 12 : 10,
                userId: data.userId,
                fading: false
            };
            activeLines.set(data.lineId, line);
            drawAllLines();
        }
        
        function updateLineFromServer(data) {
            const line = activeLines.get(data.lineId);
            if (line) {
                line.points.push(data.point);
                drawAllLines();
            }
        }
        
        function endLineFromServer(data) {
            const line = activeLines.get(data.lineId);
            if (line) {
                // –ü–æ–º–µ—á–∞–µ–º –ª–∏–Ω–∏—é –¥–ª—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
                line.fading = true;
                line.endTime = Date.now();
                
                // –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ —É–¥–∞–ª—è–µ–º –ª–∏–Ω–∏—é
                setTimeout(() => {
                    activeLines.delete(data.lineId);
                    drawAllLines();
                }, 5000);
                
                drawAllLines();
            }
        }

        // === –õ–û–ö–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ö–ê–°–ê–ù–ò–ô ===
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd);
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (!isConnected) return;
            
            const touch = e.changedTouches[0];
            const point = { x: touch.clientX, y: touch.clientY };
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            createVibrationEffect(point.x, point.y);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ª–∏–Ω–∏—é
            currentLineId = 'line_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const line = {
                id: currentLineId,
                points: [point],
                color: userColor,
                width: isIOS ? 12 : 10,
                userId: userId,
                fading: false
            };
            
            activeLines.set(currentLineId, line);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            ws.send(JSON.stringify({
                type: 'line_start',
                lineId: currentLineId,
                point: point,
                userColor: userColor,
                userId: userId,
                platform: isIOS ? 'ios' : isAndroid ? 'android' : 'desktop'
            }));
            
            drawAllLines();
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isConnected || !currentLineId) return;
            
            const touch = e.changedTouches[0];
            const point = { x: touch.clientX, y: touch.clientY };
            
            const line = activeLines.get(currentLineId);
            if (line) {
                line.points.push(point);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                ws.send(JSON.stringify({
                    type: 'line_update',
                    lineId: currentLineId,
                    point: point
                }));
                
                drawAllLines();
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!isConnected || !currentLineId) return;
            
            const line = activeLines.get(currentLineId);
            if (line) {
                line.fading = true;
                line.endTime = Date.now();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                ws.send(JSON.stringify({
                    type: 'line_end',
                    lineId: currentLineId
                }));
                
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    activeLines.delete(currentLineId);
                    drawAllLines();
                }, 5000);
                
                currentLineId = null;
                drawAllLines();
            }
        }

        // === –í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–§–§–ï–ö–¢–´ ===
        function createVibrationEffect(x, y) {
            // –ù–∞—Å—Ç–æ—è—â–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            const effect = document.createElement('div');
            effect.className = 'vibration-effect';
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            effect.style.color = userColor;
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 500);
        }

        // === –†–ò–°–û–í–ê–ù–ò–ï ===
        function drawAllLines() {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.fillStyle = '#0f0f0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –≤—Å–µ –ª–∏–Ω–∏–∏
            for (const [lineId, line] of activeLines) {
                if (line.points.length < 2) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ (–æ—Ç–ø–µ—á–∞—Ç–æ–∫)
                    drawFingerprint(line.points[0].x, line.points[0].y, line.color);
                    continue;
                }
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
                ctx.beginPath();
                ctx.moveTo(line.points[0].x, line.points[0].y);
                
                for (let i = 1; i < line.points.length; i++) {
                    ctx.lineTo(line.points[i].x, line.points[i].y);
                }
                
                // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –∏—Å—á–µ–∑–∞—é—â–∏—Ö –ª–∏–Ω–∏–π
                let alpha = 1;
                if (line.fading) {
                    const timeSinceEnd = Date.now() - line.endTime;
                    alpha = 1 - (timeSinceEnd / 5000);
                    alpha = Math.max(0, Math.min(1, alpha));
                }
                
                ctx.strokeStyle = line.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                ctx.lineWidth = line.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }
            
            // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
            if (Array.from(activeLines.values()).some(line => line.fading)) {
                requestAnimationFrame(drawAllLines);
            }
        }
        
        function drawFingerprint(x, y, color) {
            ctx.save();
            ctx.globalAlpha = 0.9;
            
            // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            
            // –í–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.restore();
        }

        // === –ü–û–î–î–ï–†–ñ–ö–ê –ú–´–®–ò (–¥–ª—è —Ç–µ—Å—Ç–∞) ===
        let isMouseDown = false;
        let mouseLineId = null;
        
        canvas.addEventListener('mousedown', (e) => {
            if (!isConnected) return;
            
            isMouseDown = true;
            const point = { x: e.clientX, y: e.clientY };
            
            mouseLineId = 'mouse_' + Date.now();
            createVibrationEffect(point.x, point.y);
            
            const line = {
                id: mouseLineId,
                points: [point],
                color: userColor,
                width: 8,
                userId: userId,
                fading: false
            };
            
            activeLines.set(mouseLineId, line);
            
            ws.send(JSON.stringify({
                type: 'line_start',
                lineId: mouseLineId,
                point: point,
                userColor: userColor,
                userId: userId,
                platform: 'desktop'
            }));
            
            drawAllLines();
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isConnected || !isMouseDown || !mouseLineId) return;
            
            const point = { x: e.clientX, y: e.clientY };
            const line = activeLines.get(mouseLineId);
            
            if (line) {
                line.points.push(point);
                
                ws.send(JSON.stringify({
                    type: 'line_update',
                    lineId: mouseLineId,
                    point: point
                }));
                
                drawAllLines();
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            if (!isConnected || !mouseLineId) return;
            
            const line = activeLines.get(mouseLineId);
            if (line) {
                line.fading = true;
                line.endTime = Date.now();
                
                ws.send(JSON.stringify({
                    type: 'line_end',
                    lineId: mouseLineId
                }));
                
                setTimeout(() => {
                    activeLines.delete(mouseLineId);
                    drawAllLines();
                }, 5000);
                
                mouseLineId = null;
                isMouseDown = false;
                drawAllLines();
            }
        });

        // === –ó–ê–ì–†–£–ó–ö–ê ===
        window.addEventListener('load', () => {
            setTimeout(() => {
                instructionsEl.classList.add('hidden');
            }, 4000);
            
            connectWebSocket();
            
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            setTimeout(() => {
                if (isConnected) {
                    alert("üíå –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏! –ö–∞—Å–∞–π—Å—è —ç–∫—Ä–∞–Ω–∞, –∏ —è —É–≤–∏–∂—É —ç—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.");
                }
            }, 1000);
        });
    </script>
</body>
</html>